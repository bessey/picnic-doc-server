import os

Import("env")

if env["TEST"] :
	if env["SCONS_STAGE"] == "flags" :
		env["UNITTEST_SOURCES"] = []
		env["UNITTEST_OBJECTS"] = []
	if env["SCONS_STAGE"] == "test" :
		myenv = env.Clone()
		myenv.MergeFlags(env.get("CHECKER_FLAGS",""))
		myenv.MergeFlags(env.get("SLIMBER_FLAGS",""))
		myenv.MergeFlags(env.get("SWIFT_CONTROLLERS_FLAGS",""))
		myenv.MergeFlags(env.get("SWIFTOOLS_FLAGS",""))
		myenv.MergeFlags(env.get("SWIFTEN_FLAGS",""))
		myenv.MergeFlags(env.get("CPPUNIT_FLAGS",""))
		myenv.MergeFlags(env.get("LIBIDN_FLAGS", ""))
		myenv.MergeFlags(env.get("BOOST_FLAGS", ""))
		myenv.MergeFlags(env.get("SQLITE_FLAGS", ""))
		myenv.MergeFlags(env.get("LIBXML_FLAGS", ""))
		myenv.MergeFlags(env.get("EXPAT_FLAGS", ""))
		myenv.MergeFlags(env.get("ZLIB_FLAGS", ""))
		myenv.MergeFlags(env.get("OPENSSL_FLAGS", ""))
		myenv.MergeFlags(env["PLATFORM_FLAGS"])
		if env.get("HAVE_LIBXML") :
			myenv.Append(CPPDEFINES = ["HAVE_LIBXML"])
		if env.get("HAVE_EXPAT") :
			myenv.Append(CPPDEFINES = ["HAVE_EXPAT"])
		checker = myenv.Program("checker", env["UNITTEST_SOURCES"] + env["UNITTEST_OBJECTS"])
		for i in ["HOME", "USERPROFILE", "APPDATA"]:
			if os.environ.get(i, "") :
				myenv["ENV"][i] = os.environ[i]
		myenv.Test(checker, is_checker = True)
